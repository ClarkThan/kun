package proto

import (
	"github.com/RussellLuo/kok/gen/grpc/parser"
	"github.com/RussellLuo/kok/gen/util/generator"
	"github.com/RussellLuo/kok/gen/util/reflector"
)

var (
	template = `// Code generated by kok; DO NOT EDIT.
// github.com/RussellLuo/kok

syntax = "proto3";

option go_package = "{{.PkgPath}}";

package {{.Result.SrcPkgName}};

{{range .Service.Descriptions -}}
{{.}}
{{- end}}
service {{.Service.Name}} {
  {{- range .Service.RPCs}}
  {{- range .Descriptions}}
  {{.}}
  {{- end}} {{/* range .Description */}}
  rpc {{.Name}} ({{.Request.Name}}) returns ({{.Response.Name}}) {}
  {{- end}} {{/* range .Service.RPCs */}}
}

{{- range .Service.RPCs}}

// The request message of {{.Name}}.
message {{.Request.Name}} {
  {{- range .Request.Fields}}
  {{if .Type.Repeated}}repeated {{end}}{{.Type.Name}} {{.Name}} = {{.Num}};
  {{- end}} {{/* range .Request.Fields */}}
}

// The response message of {{.Name}}.
message {{.Response.Name}} {
  {{- range .Response.Fields}}
  {{if .Type.Repeated}}repeated {{end}}{{.Type.Name}} {{.Name}} = {{.Num}};
  {{- end}} {{/* range .Response.Fields */}}
}
{{- end}} {{/* range .Service.RPCs */}}

{{- range .Messages}}

{{if .Fields -}}
message {{.Name}} {
  {{- range .Fields}}
  {{if .Type.Repeated}}repeated {{end}}{{.Type.Name}} {{.Name}} = {{.Num}};
  {{- end}} {{/* range .Fields */}}
}
{{- end}}{{/* if .Fields */}}

{{- end}} {{/* range .Messages */}}
`
)

type Options struct {
	SchemaPtr bool
	SchemaTag string
	Formatted bool
}

type Generator struct {
	opts *Options
}

func New(opts *Options) *Generator {
	return &Generator{opts: opts}
}

func (g *Generator) Generate(pkgPath string, result *reflector.Result, doc *reflector.InterfaceDoc) (*generator.File, error) {
	service, err := parser.Parse(result, doc)
	if err != nil {
		return nil, err
	}

	data := struct {
		PkgPath  string
		Result   *reflector.Result
		Service  *parser.Service
		Messages map[string]*parser.Type
	}{
		PkgPath:  pkgPath,
		Result:   result,
		Service:  service,
		Messages: getMessages(service),
	}

	return generator.Generate(template, data, generator.Options{
		TargetFileName: result.SrcPkgName + ".proto",
	})
}

func getMessages(s *parser.Service) map[string]*parser.Type {
	// TODO: Import another .proto's definitions, if necessary, for best reusability.

	types := make(map[string]*parser.Type)

	addTypes := func(fields []*parser.Field) {
		for _, f := range fields {
			for _, t := range f.Type.Squash() {
				types[t.Name] = t
			}
		}
	}

	for _, rpc := range s.RPCs {
		addTypes(rpc.Request.Fields)
		addTypes(rpc.Response.Fields)
	}

	return types
}
